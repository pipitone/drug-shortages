---
title: "R Notebook"
output: html_notebook
---

Note: meant to be use used in conjunction with the dashboard.Rmd setup. 
### Shortages by ATC code
```{r}
dsc.shortages %>%
  filter(actual_start_date > ymd("2019-01-01")) %>%
  filter(status %in% c("resolved", "active_confirmed")) %>%
  group_by(dpd_atc_number) %>%
  summarize(n=n()) %>%
  filter(n>40) %>%
  ggplot(aes(x=dpd_atc_number,y=n)) +
    geom_bar(stat="identity")
```
### Diltiazem
```{r}
ramipril = "C09AA05"
diltiazem = "C08DB01"
candesarten = "C09CA06"
gabapentin = "N03AX12"

dsc %>%
  filter(dpd_atc_number == hcs) %>%
  #filter(int_overlaps("2017-01-01" %--% "2019-12-31", actual_start_date %--% end_date_no_na) | 
  #         discontinuation_date %within% interval(parse_date("2017-01-01"), parse_date("2019-12-31"))) %>%
  mutate(
    start_date = coalesce(actual_start_date, anticipated_start_date), 
    actual_end_date_near = replace_na(actual_end_date, parse_datetime("2020-01-01")), 
    actual_end_date_far  = replace_na(actual_end_date, parse_datetime("2020-04-01")), 
    label = factor(din),
    label = fct_reorder(label, start_date, .desc=F), 
    ) %>%
  ggplot(aes(x=start_date, y=label, yend=label, color = reason)) + 
    geom_segment(size=2, aes(xend=actual_end_date_near), linetype="solid") + 
    geom_point(aes(x=discontinuation_date), color = "red", size = 2, shape = 4, stroke = 2) + 
    facet_grid(company_name~., scales="free_y", space="free_y") + 
    scale_colour_brewer(palette = "Paired") + 
    theme(strip.placement="outside", 
          strip.text.y = element_text(angle=0), 
          strip.background = element_rect(color="white", fill="#EEEEEE")) +
    labs(y = NULL, x="Time", color="Reason for shortage", 
         title="Shortages/Discontinuations") + 
    caption
    
```

### Proportion of marketed drugs available over time
```{r}
.dpd_status_ordered = dpd$status %>%
  group_by(DRUG_CODE) %>%
  arrange(HISTORY_DATE, .by_group = T) %>%
  mutate(.curr = 1:n(), .prev = .curr-1, .last = n()) %>%
  ungroup()

# complex join so that LHS has FROM status and RHS has TO status
# Also includes pair when LHS is the most recent status and then RHS is ignored
dpd_status_intervals = inner_join(.dpd_status_ordered, .dpd_status_ordered, by="DRUG_CODE") %>%
  select(-starts_with("CURRENT"), -starts_with("LOT"), -starts_with("EXP")) %>%
  filter(.prev.y == .curr.x | (.curr.x == .last.x & .curr.x == .curr.y)) %>%
  transmute(
    DRUG_CODE = DRUG_CODE, 
    start_date = HISTORY_DATE.x,
    end_date = if_else(.curr.x == .last.x, as_date(FAR_FUTURE), HISTORY_DATE.y), 
    status = STATUS.x)

# now, for each month, let's compute the total number of drugs marketed, for each ATC code
dpd.months = tibble(
  month.date = seq(as_date("2017-01-01"), as_date("2020-01-01"), by='1 month'), 
  n = 1)

dpd_num_marketed_by_atc = dpd_status_intervals %>% mutate(n=1) %>%
  inner_join(dpd.months, by="n") %>%
  filter(month.date %within% interval(start_date, end_date)) %>%
  select(DRUG_CODE, status, month.date) %>%
  inner_join(select(dpd$ther, DRUG_CODE, TC_ATC_NUMBER), by = "DRUG_CODE") %>%
  group_by(month.date, TC_ATC_NUMBER) %>%
  summarize(marketed = sum(status == "MARKETED"))

dsc_num_shortages_by_atc = dsc.shortages %>%
  mutate(n=1) %>%
  inner_join(dpd.months, by="n") %>%
  filter(month.date %within% interval(actual_start_date, end_date_no_na)) %>%
  distinct(month.date, dpd_atc_number, din) %>%
  group_by(month.date, dpd_atc_number) %>%
  summarize(shortages = n())

diltiazem = "C08DB01"
potassium = "A12BA01"
hcs = "D07AA02"

right_join(dsc_num_shortages_by_atc, dpd_num_marketed_by_atc, by = c("month.date" = "month.date", "dpd_atc_number" = "TC_ATC_NUMBER")) %>%
  mutate(shortages = replace_na(shortages, 0), 
    percent_available = (marketed - shortages) / marketed * 100) %>%
  inner_join(eml, by= c("dpd_atc_number" = "ATC")) %>%
  filter(dpd_atc_number == candesarten) %>%
  ggplot(aes(x = month.date, color = medication, ymin = shortages, ymax = marketed)) +
    geom_ribbon(aes(fill = medication)) + 
    facet_wrap(~medication) + 
    theme(legend.position="none")

# What is up with HCS? 
inner_join(dpd$ther, filter(dpd$status, CURRENT_STATUS_FLAG == 'Y')) %>%
  filter(TC_ATC_NUMBER == hcs) %>%
  inner_join(dpd$comp)

View(filter(dsc, dpd_atc_number == hcs))
```


### How well are ATC_number's recorded
```{r}
#TODO why NA? 
#TODO why NA in dpd_atc_number
dsc.shortages %>%
  filter(actual_start_date > ymd("2019-01-01")) %>%
  mutate(atc_length = str_length(atc_number)) %>%
  group_by(atc_length) %>%
  summarize(n = n()) %>%
  arrange(atc_length)
```

### Duplicate DINs in the DPD
```{r}
dpd$drug %>%
  group_by(DRUG_IDENTIFICATION_NUMBER) %>%
  summarize(n=n()) %>%
  filter(n > 1) %>%
  arrange(desc(n))
```

### DSC ATC fields that aren't prefixes of the DPD's ATC
```{r}
dsc %>%
  select(atc_number, dpd_atc_number) %>%
  mutate(tc_substr = substring(dpd_atc_number, 1, str_length(atc_number))) %>%
  filter(atc_number != tc_substr)
```

### redo the EML analysis with the patched ATCs
```{r}
dsc.shortages %>%
  filter(int_overlaps("2019-01-01" %--% "2019-12-31", actual_start_date %--% end_date_no_na)) %>%
  right_join(eml, by=c("dpd_atc_number" = "ATC"))  %>%
  filter(!is.na(din))  %>%
  group_by(category, medication, dpd_atc_number) %>%
  summarize(Shortages = n()) %>%
  rename(Category = category, 
         Medication = medication,
         ATC = dpd_atc_number) %>%
  arrange(desc(Shortages))
```

All 2019 shortages by EML category
```{r}
dsc.shortages %>%
  filter(int_overlaps("2019-01-01" %--% "2019-12-31", actual_start_date %--% end_date_no_na)) %>%
  left_join(eml, by=c("dpd_atc_number" = "ATC"))  %>%
  mutate(category = replace_na(category, "Not an essential medicine")) %>%
  mutate(category = str_replace(category, " -.*", "")) %>%
  group_by(category) %>%
  summarize(Shortages = n()) %>%
  mutate(percent_shortages = round(Shortages/sum(Shortages) * 100, digits=2)) %>%
  arrange(desc(percent_shortages)) %>%
  rename(Category = category, 
         "% of all shortages" = percent_shortages)
```


### Shortages for an ATC superclass
```{r}
dsc.shortages %>%
  filter(actual_start_date > "2018-01-01") %>%
  mutate(atc_short = substr(atc_number,1,5)) %>%
  filter(atc_short == "C09CA") %>%
  mutate(
    actual_end_date_near = replace_na(actual_end_date, parse_datetime("2020-01-01")), 
    actual_end_date_far  = replace_na(actual_end_date, parse_datetime("2020-04-01")), 
    id = fct_reorder(factor(id), actual_start_date), 
    ) %>%
  ggplot(aes(x=actual_start_date, y=id, yend=id, color = reason)) + 
    geom_segment(size=1, aes(xend=actual_end_date_near), linetype="solid") + 
    facet_grid(company_name~., scales="free_y", space="free_y") + 
    scale_colour_brewer(palette = "Paired") + 
    theme(strip.placement="outside", 
          strip.text.y = element_blank(), 
          axis.text.y = element_blank()) +
    labs(y=NULL, x=NULL, color="Reason for shortage", 
         title="Shortages for in C09CA") + 
    caption
```


### Do shortages occur during particular times of the year, etc?

```{r}
durations = dsc.shortages %>%
  filter(status %in% c("resolved")) %>%
  mutate(start_yday = yday(actual_start_date), 
         end_yday = yday(actual_end_date), 
         duration = interval(actual_start_date, actual_end_date)/days(1))
durations %>%
  filter(duration < 2000) %>%
  mutate(i=1) %>%
  inner_join(tibble(i = 1, yday = seq(1, 365))) %>%
  filter(start_yday <= yday & yday <= end_yday) %>%
  ggplot(aes(x=as_date(yday-1))) + 
    geom_histogram(bins=365) + 
    labs(title="shortages by day of year")

durations %>%
  ggplot(aes(x=yday(actual_start_date))) + 
  geom_histogram(bins=365) + 
  labs(title="shortage START date by day of year")

durations %>%
  filter(!is.na(created_date)) %>%
  ggplot(aes(x=wday(created_date, week_start=1, label=T))) + 
  geom_histogram(bins=7,stat="count")
```

### 
### Advanced warning
```{r}
dsc.shortages %>%
  filter(actual_start_date > ymd("2019-01-01")) %>%
  mutate(warning = round(interval(created_date, actual_start_date)/months(1)), 
         reason = fct_infreq(reason)) %>%
  filter(warning < 24) %>%
  ggplot(aes(x=warning)) + 
  geom_rect(xmin=0,xmax=6,ymin=0,ymax=2000,alpha=0.1,fill="lightgrey") + 
  geom_histogram(binwidth=1) + 
  facet_wrap(~reason) + 
  labs(x="Time between report created and shortage start date (months)", 
       y = "Number of shortages", 
       title = "Advanced warning for shortages") + 
  scale_y_log10() + 
  caption
```  
