---
title: "R Notebook"
output: html_notebook
---

Note: meant to be use used in conjunction with the dashboard.Rmd setup. 

### A closer look at a single drug's shortages / discontinuations 
```{r}
ramipril = "C09AA05"
diltiazem = "C08DB01"
candesartan = "C09CA06"
gabapentin = "N03AX12"

dsc %>%
  filter(dpd_atc_number == diltiazem) %>%
  #filter(int_overlaps("2017-01-01" %--% "2019-12-31", actual_start_date %--% end_date_no_na) | 
  #         discontinuation_date %within% interval(parse_date("2017-01-01"), parse_date("2019-12-31"))) %>%
  mutate(
    start_date = coalesce(actual_start_date, anticipated_start_date), 
    actual_end_date_near = replace_na(actual_end_date, parse_datetime("2020-01-01")), 
    actual_end_date_far  = replace_na(actual_end_date, parse_datetime("2020-04-01")), 
    label = factor(din),
    label = fct_reorder(label, start_date, .desc=F), 
    ) %>%
  ggplot(aes(x=start_date, y=label, yend=label, color = reason)) + 
    geom_segment(size=2, aes(xend=actual_end_date_near), linetype="solid") + 
    geom_point(aes(x=discontinuation_date), color = "red", size = 2, shape = 4, stroke = 2) + 
    facet_grid(company_name~., scales="free_y", space="free_y") + 
    scale_colour_brewer(palette = "Paired") + 
    theme(strip.placement="outside", 
          strip.text.y = element_text(angle=0), 
          strip.background = element_rect(color="white", fill="#EEEEEE")) +
    labs(y = NULL, x="Time", color="Reason for shortage", 
         title="Shortages/Discontinuations") + 
    caption
    
```

### Proportion of marketed drugs available over time

First we do some setup
```{r setup}
.dpd_status_ordered = dpd$status %>%
  group_by(DRUG_CODE) %>%
  arrange(HISTORY_DATE, .by_group = T) %>%
  mutate(.curr = 1:n(), .prev = .curr-1, .last = n()) %>%
  ungroup()

# complex join so that LHS has FROM status and RHS has TO status
# Also includes pair when LHS is the most recent status and then RHS is ignored
dpd_status_intervals = inner_join(.dpd_status_ordered, .dpd_status_ordered, by="DRUG_CODE") %>%
  select(-starts_with("CURRENT"), -starts_with("LOT"), -starts_with("EXP")) %>%
  filter(.prev.y == .curr.x | (.curr.x == .last.x & .curr.x == .curr.y)) %>%
  transmute(
    DRUG_CODE = DRUG_CODE, 
    start_date = HISTORY_DATE.x,
    end_date = if_else(.curr.x == .last.x, as_date(FAR_FUTURE), HISTORY_DATE.y), 
    status = STATUS.x)

```


Now, let's look more in depth at a single drug's availability:
```{r}

# date range to show 
FROM = as_date("2010-01-01")
TO = as_date("2020-01-01")
BY = "1 month"  # warning: if the FROM-TO range is large (e.g. > 20 years), change BY to something larger, e.g. 3 months

# now, for each month, let's compute the total number of drugs marketed, for each ATC code
dpd.months = tibble(month.date = seq(FROM, TO, by=BY),  n = 1)

dpd_num_marketed_by_atc = dpd_status_intervals %>% mutate(n=1) %>%
  inner_join(dpd.months, by="n") %>%
  filter(month.date %within% interval(start_date, end_date)) %>%
  select(DRUG_CODE, status, month.date) %>%
  inner_join(select(dpd$ther, DRUG_CODE, TC_ATC_NUMBER), by = "DRUG_CODE") %>%
  group_by(month.date, TC_ATC_NUMBER) %>%
  summarize(marketed = sum(status == "MARKETED"))

dsc_num_shortages_by_atc = dsc.shortages %>%
  mutate(n=1) %>%
  inner_join(dpd.months, by="n") %>%
  filter(month.date %within% interval(actual_start_date, end_date_no_na)) %>%
  distinct(month.date, dpd_atc_number, din) %>%
  group_by(month.date, dpd_atc_number) %>%
  summarize(shortages = n())

# useful ATC codes
diltiazem = "C08DB01"
potassium = "A12BA01"
hcs = "D07AA02"
ranitidine = "A02BA02"
famotidine = "A02BA03"
candesarten = "C09CA06"

right_join(dsc_num_shortages_by_atc, dpd_num_marketed_by_atc, 
           by = c("month.date" = "month.date", "dpd_atc_number" = "TC_ATC_NUMBER")) %>%
  filter(dpd_atc_number == hcs) %>%   # Select DRUGS here
  mutate(Marketed = marketed, 
         Available = marketed - shortages, 
         "In shortage" = shortages) %>%
  pivot_longer(cols = Marketed:Available, names_to = "status", values_to = "count") %>%
  ggplot(aes(x = month.date, y=count, linetype = fct_rev(status))) +
    geom_line(alpha = 0.8) + 
    #facet_wrap(. ~ dpd_atc_number, ncol=1) +
    labs(x="Date", y = "# of DINs",
         colour = NULL, 
         linetype = NULL, 
         title = "Availability of Topical Hydrocortisone") + 
    expand_limits(y=0) + 
  caption
```

## Ranitidine and Famotidine story

### manufacturers over time
```{r}
ranitidine = "A02BA02"
famotidine = "A02BA03"

dpd.months.long = tibble(
  month.date = seq(as_date("1980-01-01"), as_date("2020-01-01"), by='1 month'), 
  n = 1)

dpd$ther %>%
  filter(TC_ATC_NUMBER %in% c(ranitidine, famotidine)) %>%
  mutate(TC_ATC_NUMBER = str_sub(TC_ATC_NUMBER, 1, 4)) %>%
  inner_join(dpd$comp, by = "DRUG_CODE") %>%
  inner_join(dpd_status_intervals, by = "DRUG_CODE") %>%
  filter(status == "MARKETED") %>%
  select(COMPANY_NAME, TC_ATC, start_date, end_date, status) %>% 
  mutate(n=1) %>%
  inner_join(dpd.months.long, by="n") %>%
  filter(month.date %within% interval(start_date, end_date)) %>% 
  group_by(month.date, TC_ATC, COMPANY_NAME) %>%
  summarize() %>%
  group_by(month.date, TC_ATC) %>%
  tally() %>%
  mutate(TC_ATC = str_to_title(TC_ATC)) %>%
  ggplot(aes(x=month.date, y = n, color = TC_ATC)) +
  geom_line() + 
  labs(title="Manufacturers of marketed products", 
       color = NULL,
       y = "Count", x = "Date")
  
  
```

And now by ATC 3rd level: 
```{r}

dpd.months.long = tibble(
  month.date = seq(as_date("2000-01-01"), as_date("2020-01-01"), by='1 month'), 
  n = 1)

data = dpd$ther %>%
  mutate(atc_class = str_sub(TC_ATC_NUMBER, 1, 4)) %>%
  inner_join(dpd$comp, by = "DRUG_CODE") %>%
  group_by(DRUG_CODE, atc_class, COMPANY_NAME)%>%
  summarise() %>%
  inner_join(filter(dpd_status_intervals, status == "MARKETED"), by = "DRUG_CODE") %>%
  select(COMPANY_NAME, atc_class, start_date, end_date, status) %>% 
  mutate(n=1) %>%
  inner_join(dpd.months.long, by="n") %>%
  filter(month.date %within% interval(start_date, end_date)) %>% 
  group_by(month.date, atc_class, COMPANY_NAME) %>%
  summarize() %>%
  group_by(month.date, atc_class) %>%
  tally()

data2 = data %>%
  filter(!is.na(atc_class)) %>%
  group_by(atc_class) %>%
  filter(max(n) > 100) 
 
data3 = data2 %>% 
  group_by(atc_class) %>% 
  arrange(month.date, .by_group = T) %>% 
  summarize(month.date = last(month.date), n = last(n))

data2 %>%
  ggplot(aes(x=month.date, y = n, colour = atc_class)) +
  geom_line() + 
  geom_label(data = data3, aes(x = month.date, y = n, label = atc_class), 
             position = position_dodge2(width=1)) + 
  scale_color_brewer(palette = "Dark2") + 
  labs(title="Manufacturers of marketed products grouped by 3rd level ATC", 
       color = NULL,
       y = "Count", x = "Date") 
  
```



### Availability 
```{r}
# now, for each month, let's compute the total number of drugs marketed, for each ATC code

dpd.months.long = tibble(
  month.date = seq(as_date("1980-01-01"), as_date("2020-01-01"), by='3 month'), 
  n = 1)

dpd_marketed.long = dpd_status_intervals %>% mutate(n=1) %>%
  inner_join(dpd.months.long, by="n") %>%
  filter(month.date %within% interval(start_date, end_date)) %>%
  select(DRUG_CODE, status, month.date) %>%
  inner_join(select(dpd$ther, DRUG_CODE, TC_ATC_NUMBER), by = "DRUG_CODE") %>%
  group_by(month.date, TC_ATC_NUMBER) %>%
  summarize(marketed = sum(status == "MARKETED"))

dsc_shortages.long = dsc.shortages %>%
  mutate(n=1) %>%
  inner_join(dpd.months.long, by="n") %>%
  filter(month.date %within% interval(actual_start_date, end_date_no_na)) %>%
  distinct(month.date, dpd_atc_number, din) %>%
  group_by(month.date, dpd_atc_number) %>%
  summarize(shortages = n())


ranitidine = "A02BA02"
famotidine = "A02BA03"
right_join(dsc_shortages.long, dpd_marketed.long, by = c("month.date" = "month.date", "dpd_atc_number" = "TC_ATC_NUMBER")) %>%
  filter(dpd_atc_number %in% c(famotidine, ranitidine)) %>%
  mutate(Marketed = marketed, 
         Available = marketed - shortages, 
         "In shortage" = shortages, 
         ) %>%
  pivot_longer(cols = Marketed:Available, names_to = "status", values_to = "count") %>%
  mutate(dpd_atc_number = factor(dpd_atc_number,  levels = c(ranitidine, famotidine),  labels = c("Ranitidine", "Famotidine"))) %>%
  ggplot(aes(x = month.date, y=count, color = dpd_atc_number, linetype = fct_rev(status))) +
    geom_line(alpha = 0.8) + 
    facet_wrap(. ~ dpd_atc_number, ncol=1) +
    labs(x="Date", y = "# of DINs",
         colour = "Drug", 
         linetype = NULL, 
         title = "Availability of Ranitidine and Famotidine") + 
  caption
```

### A look at anti-acids more broadly

First let's look at h2 blockers, and make a crude plot of total din availability and shortages
```{r}
h2blockers = "A02BA"
h2blocker_shortages = dsc_num_shortages_by_atc %>%
  filter(str_starts(dpd_atc_number, h2blockers))

h2blockers_marketed = dpd_num_marketed_by_atc  %>%
  filter(str_starts(TC_ATC_NUMBER, h2blockers))

right_join(h2blocker_shortages, h2blockers_marketed, by = c("month.date" = "month.date", "dpd_atc_number" = "TC_ATC_NUMBER")) %>%
  ungroup() %>%
  mutate(shortages = replace_na(shortages, 0)) %>%
  mutate(available = marketed - shortages) %>%
  group_by(month.date) %>%
  summarize(Available = sum(available), Marketed = sum(marketed)) %>%
  pivot_longer(cols = Available:Marketed, names_to = "status", values_to = "count") %>%
  ggplot(aes(x = month.date, y = count, linetype = fct_rev(status))) +
    geom_line()  + 
    labs(x="Date", y = "# of DINs", 
         linetype = NULL, title = "Availability of H2-blockers") + 
    expand_limits(y=0) + 
  
  caption
  
```

Broken out by ATC code: 
```{r}
right_join(h2blocker_shortages, h2blockers_marketed, by = c("month.date" = "month.date", "dpd_atc_number" = "TC_ATC_NUMBER")) %>%
  ungroup() %>%
  mutate(shortages = replace_na(shortages, 0)) %>%
  mutate(available = marketed - shortages) %>%
  group_by(month.date, dpd_atc_number) %>%
  summarize(Available = sum(available), Marketed = sum(marketed)) %>%
  pivot_longer(cols = Available:Marketed, names_to = "status", values_to = "count") %>%
  ggplot(aes(x = month.date, y = count, linetype = fct_rev(status))) +
    geom_line()  + 
    labs(x="Date", y = "# of DINs",  linetype = NULL, 
         title = "Availability of H2-blockers") + 
    expand_limits(y=0) + 
    facet_wrap(~dpd_atc_number) + 
    caption 

```

And now, all antacids: 

```{r}
antacids = "A02B"
antacid_shortages = dsc_num_shortages_by_atc %>%
  filter(str_starts(dpd_atc_number, antacids))

antacids_marketed = dpd_num_marketed_by_atc  %>%
  filter(str_starts(TC_ATC_NUMBER, antacids))

right_join(antacid_shortages, antacids_marketed, by = c("month.date" = "month.date", "dpd_atc_number" = "TC_ATC_NUMBER")) %>%
  ungroup() %>%
  mutate(shortages = replace_na(shortages, 0)) %>%
  mutate(available = marketed - shortages) %>%
  mutate(atc_4th = str_sub(dpd_atc_number, 1,5)) %>%
  group_by(month.date, atc_4th) %>%
  summarize(Available = sum(available), Marketed = sum(marketed)) %>%
  pivot_longer(cols = Available:Marketed, names_to = "status", values_to = "count") %>%
  ggplot(aes(x = month.date, y = count, linetype = fct_rev(status))) +
    geom_line()  + 
    labs(x="Date", y = "# of DINs",  linetype = NULL, 
         title = "Availability of drugs for peptic ulcer and GERD") + 
    expand_limits(y=0) + 
    facet_wrap(~atc_4th) + 
    caption
```

First, the visual plotting of the shortages and discontinuations. 

```{r}
dsc %>%
  filter(dpd_atc_number == ranitidine) %>%
  mutate(
    start_date = coalesce(actual_start_date, anticipated_start_date), 
    actual_end_date_near = replace_na(actual_end_date, parse_datetime("2020-01-01")), 
    actual_end_date_far  = replace_na(actual_end_date, parse_datetime("2020-04-01")), 
    label = factor(din),
    label = fct_reorder(label, start_date, .desc=F), 
    reason = replace_na(reason, "Other"), 
    ) %>%
  ggplot(aes(x=start_date, y=label, yend=label, color = reason)) + 
    geom_segment(size=2, aes(xend=actual_end_date_near), linetype="solid") + 
    geom_point(aes(x=discontinuation_date), color = "black", size = 2, shape = 4, stroke = 2) + 
    facet_grid(company_name~., scales="free_y", space="free_y") + 
    scale_colour_brewer(palette = "Paired") + 
    theme(strip.placement="outside", 
          strip.text.y = element_text(angle=0), 
          strip.background = element_rect(color="white", fill="#EEEEEE")) +
    labs(y = "DIN", x="Date", color="Reason for shortage", 
         title="Shortages/Discontinuations of Ranitidine") + 
    caption
```

```{r}
dsc %>%
  filter(dpd_atc_number == famotidine) %>%
  mutate(
    start_date = coalesce(actual_start_date, anticipated_start_date), 
    actual_end_date_near = replace_na(actual_end_date, parse_datetime("2020-01-01")), 
    actual_end_date_far  = replace_na(actual_end_date, parse_datetime("2020-04-01")), 
    label = factor(din),
    label = fct_reorder(label, start_date, .desc=F), 
    reason = replace_na(reason, "Other"), 
    ) %>%
  ggplot(aes(x=start_date, y=label, yend=label, color = reason)) + 
    geom_segment(size=2, aes(xend=actual_end_date_near), linetype="solid") + 
    geom_point(aes(x=discontinuation_date), color = "black", size = 2, shape = 4, stroke = 2) + 
    facet_grid(company_name~., scales="free_y", space="free_y") + 
    scale_colour_brewer(palette = "Paired") + 
    theme(strip.placement="outside", 
          strip.text.y = element_text(angle=0), 
          strip.background = element_rect(color="white", fill="#EEEEEE")) +
    labs(y = NULL, x="Date", color="Reason for shortage", 
         title="Shortages/Discontinuations of Famotidine") + 
    caption

```

## Data quality 

### How well are ATC_number's recorded
```{r}
#TODO why NA? 
#TODO why NA in dpd_atc_number
dsc.shortages %>%
  filter(actual_start_date > ymd("2019-01-01")) %>%
  mutate(atc_length = str_length(atc_number)) %>%
  group_by(atc_length) %>%
  summarize(n = n()) %>%
  arrange(atc_length)
```

### Duplicate DINs in the DPD
```{r}
dpd$drug %>%
  group_by(DRUG_IDENTIFICATION_NUMBER) %>%
  summarize(n=n()) %>%
  filter(n > 1) %>%
  arrange(desc(n))
```

### DSC ATC fields that aren't prefixes of the DPD's ATC
```{r}
dsc %>%
  select(atc_number, dpd_atc_number) %>%
  mutate(tc_substr = substring(dpd_atc_number, 1, str_length(atc_number))) %>%
  filter(atc_number != tc_substr)
```

## Timing

### Do shortages occur during particular times of the year, etc?

```{r}
durations = dsc.shortages %>%
  filter(status %in% c("resolved")) %>%
  mutate(start_yday = yday(actual_start_date), 
         end_yday = yday(actual_end_date), 
         duration = interval(actual_start_date, actual_end_date)/days(1))
durations %>%
  filter(duration < 2000) %>%
  mutate(i=1) %>%
  inner_join(tibble(i = 1, yday = seq(1, 365))) %>%
  filter(start_yday <= yday & yday <= end_yday) %>%
  ggplot(aes(x=as_date(yday-1))) + 
    geom_histogram(bins=365) + 
    labs(title="shortages by day of year")

durations %>%
  ggplot(aes(x=yday(actual_start_date))) + 
  geom_histogram(bins=365) + 
  labs(title="shortage START date by day of year")

durations %>%
  filter(!is.na(created_date)) %>%
  ggplot(aes(x=wday(created_date, week_start=1, label=T))) + 
  geom_histogram(bins=7,stat="count")
```

### Advanced warning
```{r}
dsc.shortages %>%
  filter(actual_start_date > ymd("2019-01-01")) %>%
  mutate(warning = round(interval(created_date, actual_start_date)/months(1)), 
         reason = fct_infreq(reason)) %>%
  filter(warning < 24) %>%
  ggplot(aes(x=warning)) + 
  geom_rect(xmin=0,xmax=6,ymin=0,ymax=2000,alpha=0.1,fill="lightgrey") + 
  geom_histogram(binwidth=1) + 
  facet_wrap(~reason) + 
  labs(x="Time between report created and shortage start date (months)", 
       y = "Number of shortages", 
       title = "Advanced warning for shortages") + 
  scale_y_log10() + 
  caption
```  
